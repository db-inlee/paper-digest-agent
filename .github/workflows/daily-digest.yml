name: Daily Paper Digest

on:
  schedule:
    # 매일 한국시간 오전 9시 (UTC 0시)
    - cron: '0 0 * * *'
  workflow_dispatch:  # 수동 실행 가능

permissions:
  contents: write  # 리포에 커밋 권한

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e .

      - name: Run Paper Digest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
          LANGSMITH_PROJECT: paper-digest-agent
          LANGSMITH_TRACING: true
        run: python -m rtc.agents.orchestrator

      - name: Copy reports to docs for GitHub Pages
        run: |
          # daily 리포트를 docs로 복사
          mkdir -p docs/daily
          cp -r reports/daily/* docs/daily/ 2>/dev/null || true

          # 인덱스 페이지 생성
          cat > docs/index.md << 'EOF'
          ---
          layout: default
          title: Paper Digest
          ---

          # Paper Digest

          > 매일 HuggingFace에서 LLM/Agent 관련 논문을 자동 수집하고 분석합니다.

          ## Daily Reports

          EOF

          # 날짜별 리포트 목록 추가 (최신순)
          for f in $(ls -r docs/daily/*.md 2>/dev/null); do
            filename=$(basename "$f" .md)
            echo "- [$filename](daily/$filename.md)" >> docs/index.md
          done

          cat >> docs/index.md << 'EOF'

          ---

          [GitHub Repository](https://github.com/${{ github.repository }})
          EOF

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add papers/ reports/ index/ docs/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            git commit -m "docs: daily paper digest for $DATE"
            git push
          fi
